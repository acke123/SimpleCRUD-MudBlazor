@using SimpleCRUD.ViewModels
@using SimpleCRUD.Services
@using MudBlazor

@inject ISnackbar Snackbar
@inject EmployeeService EmployeeService


<EditForm Model="@model" OnValidSubmit="OnValidSubmit">
    <MudDialog>
        <DialogContent>
            <DataAnnotationsValidator />
            <MudGrid Class="mb-5">
                <MudItem xs="9">
                    <MudTextField
                        Variant="Variant.Outlined"
                        ShrinkLabel
                        Label="Full Name"
                        @bind-Value="model.FullName"
                        For="@(() => model.FullName)" />
                </MudItem>
                <MudItem xs="3">
                    <MudTextField
                        Variant="Variant.Outlined"
                        ShrinkLabel
                        Label="Age"
                        @bind-Value="model.Age"
                        For="@(() => model.Age)" />
                </MudItem>
            </MudGrid>

            <MudDatePicker Class="mb-5" Variant="Variant.Outlined" Label="Date of Birth" @bind-Date="_date" />
            <MudTextField Class="mb-5" Variant="Variant.Outlined"
                ShrinkLabel
                Label="Department"
                @bind-Value="model.Department"
                For="@(() => model.Department)" />
            <MudTextField Variant="Variant.Outlined"
                ShrinkLabel
                Label="Phone Number"
                @bind-Value="model.PhoneNumber"
                For="@(() => model.PhoneNumber)"
                InputType="InputType.Telephone" />

        </DialogContent>
        <DialogActions>
            <MudButton OnClick="Cancel">Cancel</MudButton>
            <MudButton ButtonType="ButtonType.Submit" Color="Color.Primary">Save</MudButton>
        </DialogActions>
    </MudDialog>
</EditForm>


@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }

    [Parameter]
    public EmployeeViewModel Employee { get; set; }

    [Parameter]
    public bool IsEditMode { get; set; }

    public DateTime? _date { get; set; } = DateTime.Today;
    public EmployeeViewModel model { get; set; } = new EmployeeViewModel();

    protected override void OnInitialized()
    {
        if (IsEditMode && Employee != null)
        {
            model = new EmployeeViewModel
            {
                EmployeeId = Employee.EmployeeId,
                FullName = Employee.FullName,
                Age = Employee.Age,
                DateOfBirth = Employee.DateOfBirth,
                Department = Employee.Department,
                PhoneNumber = Employee.PhoneNumber
            };
            _date = Employee.DateOfBirth;
        }
    }

    private async Task OnValidSubmit(EditContext editContext)
    {
        if (_date is not null)
        {
            model.DateOfBirth = _date.Value;
        }

        bool result;
        string successMessage;
        string errorMessage;

        if (IsEditMode)
        {
            result = await EmployeeService.UpdateEmployee(model);
            successMessage = "Successfully updated the employee!";
            errorMessage = "Failed to update the employee!";
        }
        else
        {
            result = await EmployeeService.CreateNewEmployee(model);
            successMessage = "Successfully created the employee!";
            errorMessage = "Failed to create the employee!";
        }

        if (result)
        {
            Snackbar.Add(successMessage, Severity.Success);
            MudDialog.Close();
        }
        else
        {
            Snackbar.Add(errorMessage, Severity.Error);
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
